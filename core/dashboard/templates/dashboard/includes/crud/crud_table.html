<!-- dashboard/templates/dashboard/includes/crud/crud_table.html -->
<!-- Ortak CRUD Tablosu Template'i -->

<div class="table-card">
    <div class="card-header-modern">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="{{ table_config.icon|default:'fas fa-list' }} me-2"></i>{{ table_config.title }}
            </h5>
            <div class="d-flex gap-2">
                {% include 'dashboard/includes/tables/table_search.html' with search_placeholder=table_config.search_placeholder search_id=table_config.search_id %}
                <button type="button" class="btn-modern primary btn-sm" data-bs-toggle="modal" data-bs-target="#add{{ table_config.model_name }}Modal">
                    <i class="fas fa-plus me-1"></i>{{ table_config.add_button_text }}
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if items %}
        <div class="table-responsive">
            <table class="table table-modern table-hover" id="{{ table_config.table_id }}">
                <thead>
                    <tr>
                        {% for header in table_headers %}
                        <th {% if header.width %}style="width: {{ header.width }}"{% endif %} 
                            {% if header.class %}class="{{ header.class }}"{% endif %}>
                            {% if header.icon %}<i class="{{ header.icon }} me-2"></i>{% endif %}
                            {{ header.title }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                
                <tbody>
                    {% for item in items %}
                    <tr data-{{ table_config.model_name_lower }}-id="{{ item.id }}">
                        {% for row_data in item.table_row_data %}
                        <td {% if row_data.class %}class="{{ row_data.class }}"{% endif %}>
                            {{ row_data.content|safe }}
                        </td>
                        {% endfor %}
                        
                        <!-- Actions Column -->
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action edit" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#edit{{ table_config.model_name }}Modal{{ item.id }}" 
                                        title="Düzenle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action view" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#view{{ table_config.model_name }}Modal{{ item.id }}" 
                                        title="Görüntüle">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action delete" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#delete{{ table_config.model_name }}Modal{{ item.id }}" 
                                        title="Sil">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if items.has_other_pages %}
            {% include 'dashboard/includes/tables/table_pagination.html' with page_obj=items %}
        {% endif %}

        {% else %}
        
            {% include 'dashboard/includes/ui/empty_state.html' with empty_icon=table_config.empty_icon empty_title=table_config.empty_title empty_message=table_config.empty_message action_button_text=table_config.add_button_text action_button_icon="fas fa-plus" action_button_attrs=table_config.empty_action_attrs %}
        
        {% endif %}
    </div>
</div>

<!-- ============================================================================= -->
<!-- dashboard/templates/dashboard/includes/crud/crud_modals.html -->
<!-- Ortak CRUD Modal'ları Template'i -->

<!-- Add Modal Template -->
<div class="modal fade modal-modern" id="add{{ modal_config.model_name }}Modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog {{ modal_config.size|default:'modal-xl' }}">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>{{ modal_config.add_title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" enctype="multipart/form-data" 
                  id="add{{ modal_config.model_name }}Form" 
                  action="{{ modal_config.add_url }}">
                {% csrf_token %}
                
                <div class="modal-body">
                    {% block add_form_content %}
                    <!-- Bu blok her model için override edilecek -->
                    {% endblock %}
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>İptal
                    </button>
                    <button type="submit" class="btn-modern success">
                        <i class="fas fa-save me-2"></i>{{ modal_config.save_text }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modals Template -->
{% for item in items %}
<div class="modal fade modal-modern" id="edit{{ modal_config.model_name }}Modal{{ item.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog {{ modal_config.size|default:'modal-xl' }}">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>{{ modal_config.edit_title }}: {{ item.title|default:item.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" enctype="multipart/form-data" 
                  id="edit{{ modal_config.model_name }}Form{{ item.id }}" 
                  action="{{ modal_config.edit_url_pattern }}{{ item.id }}/">
                {% csrf_token %}
                <input type="hidden" name="{{ modal_config.model_name_lower }}_id" value="{{ item.id }}">
                
                <div class="modal-body">
                    {% block edit_form_content %}
                    <!-- Bu blok her model için override edilecek -->
                    {% endblock %}
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>İptal
                    </button>
                    <button type="submit" class="btn-modern success">
                        <i class="fas fa-save me-2"></i>Değişiklikleri Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade modal-modern" id="view{{ modal_config.model_name }}Modal{{ item.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog {{ modal_config.view_size|default:'modal-lg' }}">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>{{ modal_config.view_title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% block view_content %}
                <!-- Bu blok her model için override edilecek -->
                {% endblock %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>Kapat
                </button>
                <button type="button" class="btn-modern primary" data-bs-toggle="modal" data-bs-target="#edit{{ modal_config.model_name }}Modal{{ item.id }}">
                    <i class="fas fa-edit"></i>Düzenle
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
{% include 'dashboard/includes/modals/delete_confirmation.html' with modal_id="delete"|add:modal_config.model_name|add:"Modal"|add:item.id item_name=item.title|default:item.name delete_action=item.id item_type=modal_config.item_type warning_message=modal_config.delete_warning %}

{% endfor %}

<!-- ============================================================================= -->
<!-- static/dashboard/js/common-crud.js -->
<!-- Ortak CRUD JavaScript Handler'ları -->

<script>
class CrudManager {
    constructor(config) {
        this.config = config;
        this.init();
    }
    
    init() {
        this.setupAddFormHandler();
        this.setupEditFormHandlers();
        this.setupDeleteHandlers();
    }
    
    setupAddFormHandler() {
        const addForm = document.getElementById(`add${this.config.modelName}Form`);
        if (addForm) {
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleFormSubmit(addForm, 'add');
            });
        }
    }
    
    setupEditFormHandlers() {
        document.querySelectorAll(`form[id^="edit${this.config.modelName}Form"]`).forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleFormSubmit(form, 'edit');
            });
        });
    }
    
    setupDeleteHandlers() {
        document.querySelectorAll('.delete-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleDelete(form);
            });
        });
    }
    
    async handleFormSubmit(form, action) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Loading state
        submitBtn.disabled = true;
        const loadingText = action === 'add' ? 'Kaydediliyor...' : 'Güncelleniyor...';
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${loadingText}`;
        
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                this.showNotification(`${itemName} başarıyla silindi!`, 'success');
                this.closeModal(form);
                this.reloadPage();
            } else {
                throw new Error('Silme işlemi başarısız');
            }
        } catch (error) {
            console.error('Delete error:', error);
            this.showNotification(`Silme işlemi sırasında hata oluştu: ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
    
    showNotification(message, type) {
        if (window.notificationSystem) {
            window.notificationSystem[type](message);
        } else {
            alert(message);
        }
    }
    
    closeModal(form) {
        const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
        if (modal) {
            modal.hide();
        }
    }
    
    reloadPage() {
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
}

// Global CRUD manager instances
window.crudManagers = {};

// Initialize CRUD manager for specific model
function initializeCrud(modelName, config) {
    window.crudManagers[modelName] = new CrudManager({
        modelName: modelName,
        itemName: config.itemName || modelName,
        ...config
    });
}

// Document ready handler
document.addEventListener('DOMContentLoaded', function() {
    // Auto-initialize based on page data
    if (typeof window.crudConfig !== 'undefined') {
        initializeCrud(window.crudConfig.modelName, window.crudConfig);
    }
});
</script>(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                const successMessage = action === 'add' 
                    ? `${this.config.itemName} başarıyla kaydedildi!`
                    : `${this.config.itemName} başarıyla güncellendi!`;
                    
                this.showNotification(successMessage, 'success');
                this.closeModal(form);
                this.reloadPage();
            } else {
                throw new Error(`${action === 'add' ? 'Kaydetme' : 'Güncelleme'} hatası`);
            }
        } catch (error) {
            console.error('Form submit error:', error);
            this.showNotification(`Bir hata oluştu: ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
    
    async handleDelete(form) {
        const submitBtn = form.querySelector('.delete-confirm-btn');
        const originalText = submitBtn.innerHTML;
        const itemName = form.dataset.itemName || this.config.itemName;
        
        // Loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Siliniyor...';
        
        try {
            const response = await fetch