{% load i18n %}

<!-- Ã‡erez Banner -->
<div id="cookie-banner" class="cookie-banner" style="display: none;">
    <div class="cookie-banner-content">
        <div class="cookie-banner-text">
            <h4 class="cookie-title">ğŸª {% trans "Ã‡erez KullanÄ±mÄ±" %}</h4>
            <p class="cookie-description">
                {% trans "Web sitemizde deneyiminizi geliÅŸtirmek iÃ§in Ã§erezler kullanÄ±yoruz. Dil tercihlerinizi hatÄ±rlamak, site performansÄ±nÄ± analiz etmek ve size Ã¶zel iÃ§erik sunmak iÃ§in Ã§erezleri kullanÄ±rÄ±z." %}
            </p>
        </div>
        
        <div class="cookie-banner-actions">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cookieManager.rejectAll()">
                {% trans "TÃ¼mÃ¼nÃ¼ Reddet" %}
            </button>
            <button type="button" class="btn btn-primary btn-sm" onclick="cookieManager.showSettings()">
                {% trans "Ayarla" %}
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="cookieManager.acceptAll()">
                {% trans "TÃ¼mÃ¼nÃ¼ Kabul Et" %}
            </button>
        </div>
    </div>
</div>

<!-- Ã‡erez AyarlarÄ± Modal -->
<div class="modal fade" id="cookieSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸª {% trans "Ã‡erez AyarlarÄ±" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <p class="text-muted mb-4">
                    {% trans "Hangi Ã§erez tÃ¼rlerinin kullanÄ±lmasÄ±na izin vermek istediÄŸinizi seÃ§ebilirsiniz. Bu ayarlarÄ± istediÄŸiniz zaman deÄŸiÅŸtirebilirsiniz." %}
                </p>
                
                <div class="cookie-categories">
                    <!-- Zorunlu Ã‡erezler -->
                    <div class="cookie-category">
                        <div class="category-header">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="necessary-cookies" checked disabled>
                                <label class="form-check-label fw-bold" for="necessary-cookies">
                                    {% trans "Zorunlu Ã‡erezler" %}
                                    <span class="badge bg-success ms-2">{% trans "Her Zaman Aktif" %}</span>
                                </label>
                            </div>
                        </div>
                        <p class="category-description text-muted small">
                            {% trans "Bu Ã§erezler web sitesinin dÃ¼zgÃ¼n Ã§alÄ±ÅŸmasÄ± iÃ§in gereklidir. Dil seÃ§iminiz, oturum bilgileriniz ve gÃ¼venlik iÃ§in gerekli Ã§erezlerdir. Devre dÄ±ÅŸÄ± bÄ±rakÄ±lamazlar." %}
                        </p>
                        <div class="category-cookies">
                            <small class="text-muted">
                                <strong>{% trans "KullanÄ±lan Ã§erezler:" %}</strong>
                                sessionid, csrftoken, main_language, dashboard_language
                            </small>
                        </div>
                    </div>
                    
                    <!-- Fonksiyonel Ã‡erezler -->
                    <div class="cookie-category">
                        <div class="category-header">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="functional-cookies">
                                <label class="form-check-label fw-bold" for="functional-cookies">
                                    {% trans "Fonksiyonel Ã‡erezler" %}
                                </label>
                            </div>
                        </div>
                        <p class="category-description text-muted small">
                            {% trans "Bu Ã§erezler geliÅŸmiÅŸ Ã¶zellikler saÄŸlar. Tema tercihlerinizi, form verilerinizi hatÄ±rlar ve kullanÄ±cÄ± deneyiminizi kiÅŸiselleÅŸtirir." %}
                        </p>
                        <div class="category-cookies">
                            <small class="text-muted">
                                <strong>{% trans "KullanÄ±lan Ã§erezler:" %}</strong>
                                theme_preference, form_data, ui_settings
                            </small>
                        </div>
                    </div>
                    
                    <!-- Analitik Ã‡erezler -->
                    <div class="cookie-category">
                        <div class="category-header">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="analytics-cookies">
                                <label class="form-check-label fw-bold" for="analytics-cookies">
                                    {% trans "Analitik Ã‡erezler" %}
                                </label>
                            </div>
                        </div>
                        <p class="category-description text-muted small">
                            {% trans "Bu Ã§erezler web sitemizin performansÄ±nÄ± anlamamÄ±za yardÄ±mcÄ± olur. Hangi sayfalarÄ±n ziyaret edildiÄŸini, ne kadar zaman geÃ§irildiÄŸini ve hata durumlarÄ±nÄ± analiz eder." %}
                        </p>
                        <div class="category-cookies">
                            <small class="text-muted">
                                <strong>{% trans "KullanÄ±lan Ã§erezler:" %}</strong>
                                _ga, _ga_*, page_views, session_time
                            </small>
                        </div>
                    </div>
                    
                    <!-- Pazarlama Ã‡erezleri -->
                    <div class="cookie-category">
                        <div class="category-header">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="marketing-cookies">
                                <label class="form-check-label fw-bold" for="marketing-cookies">
                                    {% trans "Pazarlama Ã‡erezleri" %}
                                </label>
                            </div>
                        </div>
                        <p class="category-description text-muted small">
                            {% trans "Bu Ã§erezler size daha alakalÄ± reklamlar gÃ¶stermek iÃ§in kullanÄ±lÄ±r. Ä°lgi alanlarÄ±nÄ±zÄ± takip eder ve kiÅŸiselleÅŸtirilmiÅŸ iÃ§erik sunar." %}
                        </p>
                        <div class="category-cookies">
                            <small class="text-muted">
                                <strong>{% trans "KullanÄ±lan Ã§erezler:" %}</strong>
                                marketing_prefs, ad_personalization, social_tracking
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Ã‡erez PolitikasÄ± Linki -->
                {% if legal_pages.cookies %}
                <div class="mt-4 pt-3 border-top">
                    <p class="mb-0">
                        <a href="{{ legal_pages.cookies.url }}" target="_blank" class="text-decoration-none">
                            <i class="fas fa-external-link-alt me-1"></i>
                            {% trans "DetaylÄ± Ã§erez politikamÄ±zÄ± okuyun" %}
                        </a>
                    </p>
                </div>
                {% endif %}
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="cookieManager.rejectAll()" data-bs-dismiss="modal">
                    {% trans "TÃ¼mÃ¼nÃ¼ Reddet" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="cookieManager.saveSettings()" data-bs-dismiss="modal">
                    {% trans "AyarlarÄ± Kaydet" %}
                </button>
                <button type="button" class="btn btn-success" onclick="cookieManager.acceptAll()" data-bs-dismiss="modal">
                    {% trans "TÃ¼mÃ¼nÃ¼ Kabul Et" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ã‡erez YÃ¶netimi JavaScript -->
<script>
class CookieManager {
    constructor() {
        this.cookieCategories = {
            necessary: true,      // Her zaman true
            functional: false,
            analytics: false,
            marketing: false
        };
        
        this.init();
    }
    
    init() {
        // Mevcut Ã§erez onayÄ±nÄ± kontrol et
        const consent = this.getCookie('cookie_consent');
        
        if (!consent) {
            // Ä°lk ziyaret - banner gÃ¶ster
            setTimeout(() => {
                document.getElementById('cookie-banner').style.display = 'block';
            }, 1000);
        } else {
            // Mevcut tercihleri yÃ¼kle
            this.loadSavedPreferences(consent);
        }
        
        // Modal aÃ§Ä±lÄ±rken mevcut ayarlarÄ± yÃ¼kle
        const modal = document.getElementById('cookieSettingsModal');
        if (modal) {
            modal.addEventListener('show.bs.modal', () => {
                this.loadModalSettings();
            });
        }
    }
    
    getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    setCookie(name, value, days = 365) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
    }
    
    loadSavedPreferences(consentString) {
        try {
            const consent = JSON.parse(decodeURIComponent(consentString));
            this.cookieCategories = { ...this.cookieCategories, ...consent };
            this.applyCookieSettings();
        } catch (e) {
            console.error('Cookie consent parsing error:', e);
        }
    }
    
    loadModalSettings() {
        document.getElementById('functional-cookies').checked = this.cookieCategories.functional;
        document.getElementById('analytics-cookies').checked = this.cookieCategories.analytics;
        document.getElementById('marketing-cookies').checked = this.cookieCategories.marketing;
    }
    
    acceptAll() {
        this.cookieCategories = {
            necessary: true,
            functional: true,
            analytics: true,
            marketing: true
        };
        this.saveConsent();
        this.hideBanner();
        this.showNotification('TÃ¼m Ã§erezler kabul edildi.', 'success');
    }
    
    rejectAll() {
        this.cookieCategories = {
            necessary: true,
            functional: false,
            analytics: false,
            marketing: false
        };
        this.saveConsent();
        this.hideBanner();
        this.showNotification('Sadece zorunlu Ã§erezler kabul edildi.', 'info');
    }
    
    saveSettings() {
        this.cookieCategories = {
            necessary: true,
            functional: document.getElementById('functional-cookies').checked,
            analytics: document.getElementById('analytics-cookies').checked,
            marketing: document.getElementById('marketing-cookies').checked
        };
        this.saveConsent();
        this.hideBanner();
        this.showNotification('Ã‡erez ayarlarÄ±nÄ±z kaydedildi.', 'success');
    }
    
    saveConsent() {
        const consentString = encodeURIComponent(JSON.stringify(this.cookieCategories));
        this.setCookie('cookie_consent', consentString);
        
        // Son gÃ¼ncelleme tarihini kaydet
        this.setCookie('cookie_consent_date', new Date().toISOString());
        
        // AyarlarÄ± uygula
        this.applyCookieSettings();
    }
    
    applyCookieSettings() {
        // Dil Ã§erezini her zaman koru (zorunlu)
        // DiÄŸer Ã§erezleri ayarlara gÃ¶re yÃ¶net
        
        if (!this.cookieCategories.functional) {
            // Fonksiyonel Ã§erezleri temizle
            this.deleteCookie('theme_preference');
            this.deleteCookie('ui_settings');
        }
        
        if (!this.cookieCategories.analytics) {
            // Analytics Ã§erezlerini temizle
            this.deleteCookie('_ga');
            this.deleteCookie('_ga_*');
        }
        
        if (!this.cookieCategories.marketing) {
            // Pazarlama Ã§erezlerini temizle
            this.deleteCookie('marketing_prefs');
        }
        
        // Google Analytics'i dinamik olarak kontrol et
        if (this.cookieCategories.analytics && typeof gtag !== 'undefined') {
            gtag('consent', 'update', {
                'analytics_storage': 'granted'
            });
        }
    }
    
    deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/`;
    }
    
    showSettings() {
        const modal = new bootstrap.Modal(document.getElementById('cookieSettingsModal'));
        modal.show();
    }
    
    hideBanner() {
        document.getElementById('cookie-banner').style.display = 'none';
    }
    
    showNotification(message, type = 'info') {
        // Bootstrap toast veya basit notification gÃ¶ster
        if (typeof bootstrap !== 'undefined') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'primary'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    }
}

// Global Ã§erez yÃ¶neticisini baÅŸlat
const cookieManager = new CookieManager();

// Global fonksiyonlar (banner'dan Ã§aÄŸrÄ±labilmesi iÃ§in)
function showCookieSettings() {
    cookieManager.showSettings();
}
</script>